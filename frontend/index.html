<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>K8s Board v1</title>
</head>
<body>
    <h1>Cloud Native 게시판</h1>
    
    <div>
        <input type="text" id="title" placeholder="제목">
        <input type="text" id="content" placeholder="내용">
        <button onclick="createPost()">작성</button>
    </div>

    <hr>

    <div style="margin-bottom: 20px;">
        <input type="text" id="searchInput" placeholder="검색어를 입력하세요">
        <button onclick="searchPosts()">검색</button>
        <button onclick="loadPosts()">초기화</button>
    </div>

    <hr>
    
    <ul id="postList"></ul>

    <script>
        // 중요: 여기에 실제 백엔드 서비스 접속 주소(NodePort IP:Port)를 넣어야 함
        // 일단 로컬 테스트용 로직 (나중에 k8s 배포 후 IP 수정 필요)
        const API_URL = "http://" + window.location.hostname + ":30001/posts"; 

        async function loadPosts(keyword = '') {
            let url = API_URL.replace('/posts', '/posts');
            
            // 검색어가 있으면 URL 뒤에 ?keyword=... 붙이기
            if (keyword) {
                url += `?keyword=${encodeURIComponent(keyword)}`;
            }

            const res = await fetch(url);
            const posts = await res.json();
            
            const list = document.getElementById('postList');
            list.innerHTML = '';
            
            if (posts.length === 0) {
                list.innerHTML = '<li>검색 결과가 없습니다.</li>';
                return;
            }

            posts.forEach(p => {
                const li = document.createElement('li');
                li.innerHTML = `
                    [${p.id}] <b>${p.title}</b> : ${p.content} 
                    <button onclick="updatePost(${p.id})">수정</button> 
                    <button onclick="deletePost(${p.id})">삭제</button>
                `;
                list.appendChild(li);
            });
        }

        // [추가] 검색 버튼 누르면 실행될 함수
        function searchPosts() {
            const keyword = document.getElementById('searchInput').value;
            loadPosts(keyword);
        }

        async function createPost() {
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            await fetch(API_URL.replace('/posts', '/posts'), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title, content})
            });
            document.getElementById('title').value = '';
            document.getElementById('content').value = '';
            loadPosts();
        }

	async function updatePost(id) {
            // 1. 사용자에게 수정할 내용을 입력받습니다.
            const newTitle = prompt("새로운 제목을 입력하세요:");
            
            // 취소 버튼을 누르면 종료
            if (newTitle === null) return;

            const newContent = prompt("새로운 내용을 입력하세요:");
            if (newContent === null) return;

            // 내용을 입력하지 않았을 경우 방어 코드
            if (!newTitle || !newContent) {
                alert("제목과 내용은 필수입니다.");
                return;
            }

            try {
                // 2. 백엔드에 수정 요청을 보냅니다.
                // [중요] 하드코딩된 IP 대신 위에서 정의한 API_URL 변수를 사용합니다.
                // 예: http://localhost:30001/posts/1
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ title: newTitle, content: newContent }),
                });

                if (response.ok) {
                    alert("성공적으로 수정되었습니다!");
                    loadPosts(); // 3. 수정 후 목록을 새로고침합니다.
                } else {
                    alert("수정 실패: 서버 오류");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("수정 중 오류가 발생했습니다.");
            }
        }

        async function deletePost(id) {
            await fetch(API_URL.replace('/posts', `/posts/${id}`), { method: 'DELETE' });
            loadPosts();
        }
        
        loadPosts();
    </script>
</body>
</html>
